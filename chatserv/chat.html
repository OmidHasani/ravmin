<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>چت با روان‌شناس</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(to bottom right, #e0f2fe, #bae6fd);
      margin: 0; height: 100vh; display: flex; flex-direction: column;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      scroll-behavior: smooth;
    }
    .msg-wrapper {
      display: flex;
      max-width: 85%;
    }
    .msg-user {
      justify-content: flex-start;
    }
    .msg-assistant {
      justify-content: flex-end;
    }
    .msg {
      padding: 14px 18px;
      border-radius: 22px;
      font-size: 1.15rem;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
      user-select: text;
      max-width: 100%;
    }
    .msg.user {
      background-color: #0ea5e9; /* آبی روشن */
      color: white;
      border-bottom-left-radius: 4px;
    }
    .msg.assistant {
      background-color: #f1f5f9; /* خاکستری روشن */
      color: #111827; /* تیره */
      border-bottom-right-radius: 4px;
    }
    header {
      background: linear-gradient(to right, #0284c7, #0369a1);
      color: white;
      padding: 16px 20px;
      font-weight: 700;
      font-size: 1.25rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.1);
      flex-shrink: 0;
    }
    #clearHistoryBtn {
      background: rgba(255 255 255 / 0.2);
      border: none;
      color: white;
      padding: 8px 14px;
      border-radius: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    #clearHistoryBtn:hover {
      background: rgba(255 255 255 / 0.35);
    }
    footer {
      padding: 10px 16px;
      background: white;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-shrink: 0;
    }
    textarea#inputMessage {
      flex-grow: 1;
      font-size: 1.15rem;
      border-radius: 22px;
      border: 1px solid #cbd5e1;
      padding: 14px 18px;
      resize: none;
      max-height: 140px;
      line-height: 1.5;
      font-family: 'Vazirmatn', sans-serif;
      outline-offset: 2px;
    }
    textarea#inputMessage:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 5px #0ea5e9aa;
      outline: none;
    }
    #sendBtn {
      background-color: #0ea5e9;
      border: none;
      color: white;
      padding: 14px 22px;
      border-radius: 22px;
      font-weight: 700;
      font-size: 1.15rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      flex-shrink: 0;
      min-width: 90px;
      text-align: center;
    }
    #sendBtn:hover {
      background-color: #0284c7;
    }
  </style>
</head>
<body>

  <header>
    <div>کلینیک آرامش</div>
    <button id="clearHistoryBtn" aria-label="پاک کردن تاریخچه">پاک کردن</button>
  </header>

  <div id="chat" role="log" aria-live="polite" aria-relevant="additions"></div>

  <footer>
    <textarea id="inputMessage" rows="1" placeholder="پیام خود را بنویسید..." aria-label="پیام"></textarea>
    <button id="sendBtn" aria-label="ارسال پیام">ارسال</button>
  </footer>

  <script>
    const memoryLimit = 10;
    let memory = JSON.parse(localStorage.getItem("publicMemory")) || [];
    let autoScroll = true;

    const chat = document.getElementById('chat');
    const inputMessage = document.getElementById('inputMessage');
    const sendBtn = document.getElementById('sendBtn');

    chat.addEventListener('scroll', () => {
      autoScroll = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 50;
    });

    function scrollToBottom() {
      chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' });
    }

    function addMessage(text, sender) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('msg-wrapper');
      wrapper.classList.add(sender === 'user' ? 'msg-user' : 'msg-assistant');

      const msgDiv = document.createElement('div');
      msgDiv.classList.add('msg', sender);
      msgDiv.textContent = text;

      wrapper.appendChild(msgDiv);
      chat.appendChild(wrapper);

      if (autoScroll) scrollToBottom();
    }

    // تایپ حرف به حرف مثل خودت
    function addMessageTyping(text, sender) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('msg-wrapper');
      wrapper.classList.add(sender === 'user' ? 'msg-user' : 'msg-assistant');

      const msgDiv = document.createElement('div');
      msgDiv.classList.add('msg', sender);

      const span = document.createElement('span');
      msgDiv.appendChild(span);
      wrapper.appendChild(msgDiv);
      chat.appendChild(wrapper);
      if (autoScroll) scrollToBottom();

      let i = 0;
      const interval = setInterval(() => {
        if (i < text.length) {
          span.textContent += text[i];
          i++;
          if (autoScroll) scrollToBottom();
        } else {
          clearInterval(interval);
        }
      }, 30);
    }

    function saveMemory() {
      localStorage.setItem("publicMemory", JSON.stringify(memory));
    }

    function buildPrompt(newMessage) {
      const historyText = memory.map(h => `${h.role === 'user' ? 'کاربر' : 'دستیار'}: ${h.content}`).join("\n");
      return [{
        role: "system",
        content: `
تو یک دستیار گفتگوی آنلاین هستی که نقش یک روانشناس غربالگر اولیه را ایفا می‌کنی.  
هدفت این است که با چند پرسش کوتاه، دقیق و هدفمند (حداکثر ۱۰ سؤال) بفهمی آیا کاربر نیاز دارد با یک روانشناس یا مشاور حرفه‌ای صحبت کند یا خیر.

قوانین مکالمه:  
1. گفتگو را دوستانه و همدلانه شروع کن، مثل یک انسان که می‌خواهد حال کاربر را بفهمد.  
2. پرسش‌ها باید عمیق باشند؛ هم وضعیت فعلی را بپرسند (چه اتفاقی افتاده؟ چه حسی داری؟) و هم چرایی و تأثیر آن را (به نظرت چرا این اتفاق روی تو این‌طور اثر گذاشته؟ چه چیزی باعث می‌شود این موضوع برایت مهم باشد؟).  
3. سؤالات را طوری طراحی کن که کاربر برای پاسخ دادن شوق داشته باشد و احساس کند واقعاً شنیده می‌شود.  
4. از پرسش‌های بی‌هدف یا زیاد پشت سر هم اجتناب کن؛ هر سؤال باید ارزشمند باشد و به درک بهتر موقعیت کمک کند.  
5. هیچ راه‌حل یا توصیه درمانی ارائه نده؛ فقط بشنو و ارزیابی کن.  
6. در طول گفتگو تحلیل کن که آیا مشکل جدی و تأثیرگذار است یا نه.  
7. اگر مشکل جدی بود، خیلی دوستانه و با دلیل واضح بگو که صحبت با مشاور می‌تواند کمک بزرگی باشد و او را به مشاوره ترغیب کن. اگر مشکل سطحی بود، نیازی به پیشنهاد مشاوره نیست.  
8. در پایان مکالمه حتماً یک جمع‌بندی کوتاه و کاملاً طبیعی از چیزی که فهمیدی ارائه بده؛ طوری که انگار داری با یک دوست همدل حرف می‌زنی.  
از عبارت‌های کلیشه‌ای مثل "پس تو گفتی" یا "این نشون می‌دهد" استفاده نکن؛ به‌جای آن خیلی انسانی و روان بگو چه برداشتی از حرف‌های کاربر داشتی..  
9. لحن باید انسانی، محترمانه، کوتاه، بدون قضاوت و همدلانه باشد؛ مثل کسی که فقط می‌خواهد بفهمد، نه درمان کند.

${historyText}
متون بالا تاریخچه مکالمه شما و کاربر هستند و فقط در صورت نیاز برای پاسخ به پیام فعلی به آنها رجوع کن.
        `
      }];
    }

    async function sendMessage() {
      const message = inputMessage.value.trim();
      if (!message) return;
      addMessage(message, 'user');

      inputMessage.value = '';
      inputMessage.style.height = 'auto';

      memory.push({ role: "user", content: message });
      if (memory.length > memoryLimit * 2) memory.splice(0, 2);
      saveMemory();

      try {
        const messages = buildPrompt(message);
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages })
        });

        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content || "پاسخی دریافت نشد.";
        addMessageTyping(reply, 'assistant');

        fetch("/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sender: "assistant", content: reply })
        });

        memory.push({ role: "assistant", content: reply });
        if (memory.length > memoryLimit * 2) memory.splice(0, 2);
        saveMemory();
      } catch (err) {
        addMessage("خطا در ارتباط با سرور", 'assistant');
      }
    }

    sendBtn.addEventListener('click', sendMessage);

    inputMessage.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    inputMessage.addEventListener('input', () => {
      inputMessage.style.height = 'auto';
      inputMessage.style.height = (inputMessage.scrollHeight) + 'px';
    });

    document.getElementById('clearHistoryBtn').onclick = () => {
      memory = [];
      localStorage.setItem("publicMemory", JSON.stringify([]));
      chat.innerHTML = "";
    };

    // بارگذاری تاریخچه

  </script>
</body>
</html>

