<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>چت با روان‌شناس</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --app-height: 100dvh; }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(to bottom right, #f0f9ff, #e0f2fe);
      margin: 0;
      height: var(--app-height);
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }
    .msg {
      animation: fadeIn .4s ease;
      display: inline-block;
      white-space: pre-wrap;
      word-break: break-word;
    }
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(8px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    #inputMessage {
      resize: none;
      overflow-y: hidden;
      max-height: 150px;
      transition: height 0.2s ease;
    }
  </style>
</head>
<body>

  <div class="flex flex-col w-full max-w-3xl mx-auto h-[var(--app-height)] bg-white shadow-xl border border-blue-100">
    <header class="bg-gradient-to-r from-sky-400 to-blue-600 text-white flex justify-between items-center p-5 shadow flex-shrink-0">
      <div>
        <h1 class="text-xl font-bold">کلینیک آرامش</h1>
        <p class="text-sm text-blue-100">چت آنلاین با روان‌شناس</p>
      </div>
      <button id="clearHistoryBtn" class="bg-gray-800/80 hover:bg-gray-900/90 px-3 py-1 rounded-xl text-sm shadow">
        پاک کردن
      </button>
    </header>

    <main id="chat" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gradient-to-b from-blue-50 to-sky-50"></main>

    <footer class="p-3 border-t border-gray-300 flex items-end flex-row-reverse space-x-2 bg-white flex-shrink-0">
      <textarea id="inputMessage" rows="1" placeholder="پیام خود را بنویسید..."
        class="flex-grow min-h-[44px] max-h-[150px] p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800 resize-none overflow-y-hidden transition-all duration-150"></textarea>
      <button id="sendBtn"
        class="bg-teal-600 text-white px-5 py-3 rounded-xl hover:bg-teal-700 transition shadow-md">
        ارسال
      </button>
    </footer>
  </div>

  <script>
    function setAppHeight() {
      document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    }
    window.addEventListener('resize', setAppHeight);
    setAppHeight();

    const memoryLimit = 10;
    let memory = JSON.parse(localStorage.getItem("publicMemory")) || [];
    let autoScroll = true;

    const chat = document.getElementById('chat');
    const inputMessage = document.getElementById('inputMessage');
    const sendBtn = document.getElementById('sendBtn');

    chat.addEventListener('scroll', () => {
      autoScroll = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 50;
    });
    function scrollToBottom() { chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' }); }

    function addMessage(text, sender) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('flex', 'w-full', 'mb-2');
      const div = document.createElement('div');
      div.setAttribute('dir', 'rtl');
      div.style.textAlign = 'right';
      div.classList.add('msg', 'p-4', 'rounded-2xl', 'leading-relaxed', 'text-[1rem]');

      if (sender === 'user') {
        wrapper.classList.add('justify-start');
        div.classList.add('bg-teal-500', 'text-white', 'shadow-md', 'max-w-[80%]');
      } else {
        wrapper.classList.add('justify-end');
        div.classList.add('bg-gradient-to-r', 'from-sky-100', 'to-blue-50', 'shadow-lg', 'text-gray-900', 'min-w-[80%]', 'max-w-[80%]');
      }
      div.textContent = text;
      wrapper.appendChild(div);
      chat.appendChild(wrapper);
      if (autoScroll) scrollToBottom();
    }

    function addMessageTyping(text, sender) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('flex', 'w-full', 'mb-3');
      const div = document.createElement('div');
      div.setAttribute('dir', 'rtl');
      div.style.textAlign = 'right';
      div.classList.add('msg', 'p-4', 'rounded-2xl', 'leading-relaxed', 'text-[1.05rem]');

      if (sender === 'user') {
        wrapper.classList.add('justify-start');
        div.classList.add('bg-teal-500', 'text-white', 'shadow-md', 'max-w-[80%]');
      } else {
        wrapper.classList.add('justify-end');
        div.classList.add('bg-gradient-to-r', 'from-sky-100', 'to-blue-50', 'shadow-lg', 'text-gray-900', 'min-w-[80%]', 'max-w-[80%]');
      }

      const span = document.createElement('span');
      span.style.display = 'inline-block';
      div.appendChild(span);
      wrapper.appendChild(div);
      chat.appendChild(wrapper);
      scrollToBottom();

      let i = 0;
      const interval = setInterval(() => {
        if (i < text.length) { span.textContent += text[i]; i++; if (autoScroll) scrollToBottom(); }
        else clearInterval(interval);
      }, 30);
    }

    function saveMemory() { localStorage.setItem("publicMemory", JSON.stringify(memory)); }

    function buildPrompt(newMessage) {
      const historyText = memory.map(h => `${h.role === 'user' ? 'کاربر' : 'دستیار'}: ${h.content}`).join("\n");
      return [{ role: "system", content: `تو یک دستیار گفتگوی آنلاین هستی که نقش یک روانشناس غربالگر اولیه را ایفا می‌کنی.\n${historyText}` }];
    }

    async function sendMessage() {
      const message = inputMessage.value.trim();
      if (!message) return;
      addMessage(message, 'user');
      fetch("/messages", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ sender: "user", content: message }) });
      inputMessage.value = ''; inputMessage.style.height = 'auto';
      memory.push({ role: "user", content: message });
      if (memory.length > memoryLimit * 2) memory.splice(0, 2);
      saveMemory();
      try {
        const messages = buildPrompt(message);
        const res = await fetch("/api/chat", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ messages }) });
        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content || "پاسخی دریافت نشد.";
        addMessageTyping(reply, 'assistant');
        fetch("/messages", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ sender: "assistant", content: reply }) });
        memory.push({ role: "assistant", content: reply });
        if (memory.length > memoryLimit * 2) memory.splice(0, 2);
        saveMemory();
      } catch { addMessage("خطا در ارتباط با سرور", 'assistant'); }
    }

    sendBtn.addEventListener('click', sendMessage);
    inputMessage.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { 
        e.preventDefault();
        sendMessage();
      }
    });
    inputMessage.addEventListener('input', () => { 
      inputMessage.style.height = 'auto'; 
      inputMessage.style.height = (inputMessage.scrollHeight) + 'px'; 
    });
    document.getElementById('clearHistoryBtn').onclick = () => { memory = []; localStorage.setItem("publicMemory", JSON.stringify([])); chat.innerHTML = ""; };
    memory.forEach(m => addMessage(m.content, m.role)); scrollToBottom();
  </script>
</body>
</html>
