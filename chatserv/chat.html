<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>چت با روان‌شناس</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Vazirmatn', sans-serif; }
    .msg { animation: fadeIn .25s ease; font-size: 1.2rem; line-height: 1.8; }
    @keyframes fadeIn { 0% { opacity: 0; transform: translateY(8px);} 100% { opacity:1; transform:translateY(0);} }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

  <!-- هدر بزرگ -->
  <header class="bg-gradient-to-r from-sky-500 to-blue-600 text-white p-5 flex justify-between items-center shadow-md">
    <div>
      <h1 class="text-2xl font-bold">کلینیک آرامش</h1>
      <p class="text-lg text-blue-100">چت با روان‌شناس</p>
    </div>
    <button id="clearHistoryBtn" class="bg-gray-900/80 hover:bg-gray-900 text-lg px-5 py-3 rounded-2xl">
      پاک کردن
    </button>
  </header>

  <!-- بخش پیام‌ها -->
  <main id="chat" class="flex-1 overflow-y-auto p-5 space-y-5">
    <!-- پیام‌ها اینجا اضافه می‌شن -->
  </main>

  <!-- ورودی درشت پایین -->
  <footer class="p-4 bg-white border-t border-gray-300 flex items-center gap-3">
    <textarea id="inputMessage" rows="1" placeholder="پیام خود را بنویسید..."
      class="flex-grow text-xl p-4 rounded-2xl border border-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-500 resize-none overflow-y-hidden"></textarea>
    <button id="sendBtn" class="bg-teal-600 text-white px-6 py-4 rounded-2xl text-xl font-bold shadow-md hover:bg-teal-700">
      ارسال
    </button>
  </footer>

  <script>
    const memoryLimit = 10;
    let memory = JSON.parse(localStorage.getItem("publicMemory")) || [];
    let autoScroll = true;

    const chat = document.getElementById('chat');
    const inputMessage = document.getElementById('inputMessage');
    const sendBtn = document.getElementById('sendBtn');

    chat.addEventListener('scroll', () => {
      autoScroll = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 50;
    });

    function addMessage(text, sender) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('flex', 'w-full');
      const div = document.createElement('div');
      div.classList.add('msg','p-5','rounded-3xl','max-w-[85%]','whitespace-pre-wrap','break-words','leading-relaxed','text-xl');
      if (sender === 'user') {
        wrapper.classList.add('justify-start');
        div.classList.add('bg-teal-600','text-white');
      } else {
        wrapper.classList.add('justify-end');
        div.classList.add('bg-blue-200','text-gray-900');
      }
      div.textContent = text;
      wrapper.appendChild(div);
      chat.appendChild(wrapper);
      if (autoScroll) chat.scrollTop = chat.scrollHeight;
    }

    function addMessageTyping(text, sender) {
      const wrapper = document.createElement('div');
      wrapper.classList.add('flex','w-full');
      const div = document.createElement('div');
      div.classList.add('msg','p-5','rounded-3xl','max-w-[85%]','whitespace-pre-wrap','break-words','leading-relaxed','text-xl');
      if (sender === 'user') {
        wrapper.classList.add('justify-start');
        div.classList.add('bg-teal-600','text-white');
      } else {
        wrapper.classList.add('justify-end');
        div.classList.add('bg-blue-200','text-gray-900');
      }
      const span = document.createElement('span');
      div.appendChild(span);
      wrapper.appendChild(div);
      chat.appendChild(wrapper);
      chat.scrollTop = chat.scrollHeight;
      let i = 0;
      const interval = setInterval(() => {
        span.textContent += text[i] || "";
        i++;
        if (autoScroll) chat.scrollTop = chat.scrollHeight;
        if (i >= text.length) clearInterval(interval);
      }, 25);
    }

    function saveMemory(){localStorage.setItem("publicMemory",JSON.stringify(memory));}

    function buildPrompt(newMessage){
      const historyText = memory.map(h => `${h.role==='user'?'کاربر':'دستیار'}: ${h.content}`).join("\n");
      return [{role:"system",content:`تو یک دستیار گفتگوی آنلاین هستی که نقش یک روانشناس غربالگر اولیه را ایفا می‌کنی. ... ${historyText}`}];
    }

    async function sendMessage(){
      const message = inputMessage.value.trim();
      if(!message)return;
      addMessage(message,'user');
      inputMessage.value='';inputMessage.style.height='auto';
      memory.push({role:"user",content:message});
      if(memory.length>memoryLimit*2)memory.splice(0,2);
      saveMemory();
      try{
        const messages=buildPrompt(message);
        const res=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages})});
        const data=await res.json();
        const reply=data.choices?.[0]?.message?.content||"پاسخی دریافت نشد.";
        addMessageTyping(reply,'assistant');
        fetch("/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sender:"assistant",content:reply})});
        memory.push({role:"assistant",content:reply});
        if(memory.length>memoryLimit*2)memory.splice(0,2);
        saveMemory();
      }catch(err){addMessage("خطا در ارتباط با سرور",'assistant');}
    }

    sendBtn.addEventListener('click',sendMessage);
    inputMessage.addEventListener('keydown',e=>{
      if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();}
    });
    inputMessage.addEventListener('input',()=>{
      inputMessage.style.height='auto';
      inputMessage.style.height=(inputMessage.scrollHeight)+'px';
    });
    document.getElementById('clearHistoryBtn').onclick=()=>{
      memory=[];localStorage.setItem("publicMemory",JSON.stringify([]));chat.innerHTML="";
    };
    chat.innerHTML="";
    memory.forEach(m=>addMessage(m.content,m.role));
  </script>
</body>
</html>
