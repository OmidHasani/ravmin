<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Ú†Øª Ø¨Ø§ Ø±ÙˆØ§Ù†â€ŒØ´Ù†Ø§Ø³</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    
    :root { --app-height: 100dvh; }
    body {
      font-family: 'Vazirmatn', sans-serif;
      background: linear-gradient(to bottom right, #f0f9ff, #e0f2fe);
      margin: 0;
      height: var(--app-height);
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    
    body > div {
      margin-top: 0 !important;
    }

    .msg {
      animation: fadeIn .4s ease;
      display: inline-block;
      white-space: pre-wrap;
      word-break: break-word;
    }
    @keyframes fadeIn {
      0% { opacity: 0; transform: translateY(8px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    #inputMessage {
      resize: none;
      overflow-y: hidden;
      max-height: 150px;
      transition: height 0.2s ease;
    }
    
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ debug console */
    #debugConsole {
      background: #1a1a1a;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 10px;
      max-height: 300px;
      overflow-y: auto;
      border-top: 2px solid #333;
      white-space: pre-wrap;
      direction: ltr;
      text-align: left;
    }
  </style>
</head>
<body>

  <div class="flex flex-col w-full max-w-3xl mx-auto h-[var(--app-height)] bg-white shadow-xl border border-blue-100">
    <header class="bg-gradient-to-r from-sky-400 to-blue-600 text-white flex justify-between items-center px-5 py-2 shadow flex-shrink-0 rounded-b-md">

      <div>
        <h1 class="text-xl font-bold">Ú©Ù„ÛŒÙ†ÛŒÚ© Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ÛŒ </h1>
        <p class="text-sm text-blue-100">Ù…Ø´Ø§ÙˆØ±Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ø¯Ø±Ù…Ø§Ù† </p>
      </div>
      <div class="flex gap-2">
        <button id="toggleDebugBtn" class="bg-red-600/80 hover:bg-red-700/90 px-3 py-1 rounded-xl text-sm shadow">
          Ù†Ù…Ø§ÛŒØ´ Debug
        </button>
        <button id="clearHistoryBtn" class="bg-gray-800/80 hover:bg-gray-900/90 px-3 py-1 rounded-xl text-sm shadow">
          Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
        </button>
      </div>
    </header>

    <main id="chat" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gradient-to-b from-blue-50 to-sky-50"></main>

    <!-- Debug Console -->
    <div id="debugConsole" class="hidden flex-shrink-0"></div>

    <footer class="p-3 border-t border-gray-300 flex items-end flex-row-reverse space-x-2 bg-white flex-shrink-0">
      <textarea id="inputMessage" rows="1" placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."
        class="flex-grow min-h-[44px] max-h-[150px] p-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500 text-gray-800 resize-none overflow-y-hidden transition-all duration-150"></textarea>
      <button id="sendBtn"
        class="bg-teal-600 text-white px-5 py-3 rounded-xl hover:bg-teal-700 transition shadow-md">
        Ø§Ø±Ø³Ø§Ù„
      </button>
    </footer>
  </div>

  <script>
    function setAppHeight() {
      document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
    }
    window.addEventListener('resize', setAppHeight);
    setAppHeight();

    const memoryLimit = 100;
    let memory = JSON.parse(localStorage.getItem("publicMemory")) || [];
    let autoScroll = true;

    const chat = document.getElementById('chat');
    const inputMessage = document.getElementById('inputMessage');
    const sendBtn = document.getElementById('sendBtn');
    const debugConsole = document.getElementById('debugConsole');
    const toggleDebugBtn = document.getElementById('toggleDebugBtn');

    // Toggle Debug Console
    toggleDebugBtn.addEventListener('click', () => {
      if (debugConsole.classList.contains('hidden')) {
        debugConsole.classList.remove('hidden');
        toggleDebugBtn.textContent = 'Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Debug';
        toggleDebugBtn.className = 'bg-green-600/80 hover:bg-green-700/90 px-3 py-1 rounded-xl text-sm shadow';
      } else {
        debugConsole.classList.add('hidden');
        toggleDebugBtn.textContent = 'Ù†Ù…Ø§ÛŒØ´ Debug';
        toggleDebugBtn.className = 'bg-red-600/80 hover:bg-red-700/90 px-3 py-1 rounded-xl text-sm shadow';
      }
    });

    // Debug logging function
    function debugLog(title, data) {
      const timestamp = new Date().toLocaleTimeString();
      debugConsole.textContent += `[${timestamp}] ${title}:\n${JSON.stringify(data, null, 2)}\n\n`;
      debugConsole.scrollTop = debugConsole.scrollHeight;
    }

    chat.addEventListener('scroll', () => {
      autoScroll = chat.scrollHeight - chat.scrollTop - chat.clientHeight < 50;
    });
    function scrollToBottom() { chat.scrollTo({ top: chat.scrollHeight, behavior: 'smooth' }); }

function addMessage(text, sender) {
  const wrapper = document.createElement('div');
  wrapper.classList.add('flex', 'w-full', 'mb-2');

  const div = document.createElement('div');
  div.setAttribute('dir', 'rtl');
  div.style.textAlign = 'right';
  div.classList.add('msg', 'p-4', 'rounded-2xl', 'leading-relaxed', 'text-[1rem]');

if (sender === 'user') {
    wrapper.classList.add('justify-start');
    div.classList.add(
      'bg-teal-500',
      'text-white',
      'shadow-md',
      'max-w-[90%]',    // Ø¹Ø±Ø¶ Ú©Ù…ØªØ±
      'p-1.8',            // Ù¾Ø¯ÛŒÙ†Ú¯ Ú©Ù…ØªØ±
      'text-[0.85rem]', // Ù…ØªÙ† Ø±ÛŒØ²ØªØ±
      'leading-snug'    // ÙØ§ØµÙ„Ù‡ Ø®Ø·ÙˆØ· Ú©Ù…ØªØ±
    );




  } else {
    wrapper.classList.add('justify-end');
    div.classList.add('bg-gradient-to-r', 'from-sky-100', 'to-blue-50', 'shadow-lg', 'text-gray-900', 'min-w-[90%]', 'max-w-[90%]');
  }

  // Ø§ÛŒÙ†Ø¬Ø§ Ù…ØªÙ† Ø±Ùˆ Ù…Ø«Ù„ Ø­Ø§Ù„Øª ØªØ§ÛŒÙ¾â€ŒØ´Ø¯Ù‡ Ø¨Ø®Ø´â€ŒØ¨Ù†Ø¯ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
  const paragraphs = text.split(/[\n\.]+/).filter(p => p.trim() !== "");
  paragraphs.forEach(p => {
    const pElement = document.createElement('p');
    pElement.textContent = p;
    pElement.style.marginBottom = "0.8em"; // ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ùâ€ŒÙ‡Ø§
    div.appendChild(pElement);
  });

  wrapper.appendChild(div);
  chat.appendChild(wrapper);
  if (autoScroll) chat.scrollTop = chat.scrollHeight;
}


function addMessageTyping(text, sender) {
  const wrapper = document.createElement('div');
  wrapper.classList.add('flex', 'w-full', 'mb-3');

  const div = document.createElement('div');
  div.setAttribute('dir', 'rtl');
  div.style.textAlign = 'right';
  div.classList.add('msg', 'p-4', 'rounded-2xl', 'leading-relaxed', 'text-[1.05rem]');

  if (sender === 'user') {
    wrapper.classList.add('justify-start');
    div.classList.add('bg-teal-500', 'text-white', 'shadow-md', 'max-w-[90%]');
  } else {
    wrapper.classList.add('justify-end');
    div.classList.add('bg-gradient-to-r', 'from-sky-100', 'to-blue-50', 'shadow-lg', 'text-gray-900', 'min-w-[90%]', 'max-w-[90%]');
  }

  const span = document.createElement('span');
  span.style.display = 'inline-block';
  span.style.direction = 'rtl';
  span.style.unicodeBidi = 'plaintext';
  span.style.textAlign = 'right';
  div.appendChild(span);

  wrapper.appendChild(div);
  chat.appendChild(wrapper);
  scrollToBottom();

  const paragraphs = text.split(/[\n\.]+/).filter(p => p.trim() !== "");
  let i = 0, pIndex = 0;
  const interval = setInterval(() => {
    span.textContent += paragraphs[pIndex][i] || "";
    i++;
    if (autoScroll) scrollToBottom();

    if (i >= paragraphs[pIndex].length) {
      span.textContent += "\n\n"; // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§ØµÙ„Ù‡ Ø¨ÛŒÙ† Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ùâ€ŒÙ‡Ø§
      pIndex++;
      i = 0;
      if (pIndex >= paragraphs.length) {
        clearInterval(interval);
      }
    }
  }, 35);
}

    function saveMemory() { localStorage.setItem("publicMemory", JSON.stringify(memory)); }

    function buildPrompt(newMessage) {
      const historyText = memory.map(h => `${h.role === 'user' ? 'Ú©Ø§Ø±Ø¨Ø±' : 'Ø¯Ø³ØªÛŒØ§Ø±'}: ${h.content}`).join("\n");
      return [{ role: "system", content: ` ØªÙˆ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ú¯ÙØªÚ¯ÙˆÛŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù‡Ø³ØªÛŒ Ú©Ù‡ Ù†Ù‚Ø´ ÛŒÚ© Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ ØºØ±Ø¨Ø§Ù„Ú¯Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø§ Ø§ÛŒÙØ§ Ù…ÛŒâ€ŒÚ©Ù†ÛŒ.  
Ù‡Ø¯ÙØª Ø§ÛŒÙ† Ø§Ø³Øª Ú©Ù‡ Ø¨Ø§ Ú†Ù†Ø¯ Ù¾Ø±Ø³Ø´ Ú©ÙˆØªØ§Ù‡ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ù‡Ø¯ÙÙ…Ù†Ø¯ (Ø­Ø¯Ø§Ú©Ø«Ø± Û±Û° Ø³Ø¤Ø§Ù„) Ø¨ÙÙ‡Ù…ÛŒ Ø¢ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ø¯ Ø¨Ø§ ÛŒÚ© Ø±ÙˆØ§Ù†Ø´Ù†Ø§Ø³ ÛŒØ§ Ù…Ø´Ø§ÙˆØ± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ ØµØ­Ø¨Øª Ú©Ù†Ø¯ ÛŒØ§ Ø®ÛŒØ±.  

Ù‚ÙˆØ§Ù†ÛŒÙ† Ù…Ú©Ø§Ù„Ù…Ù‡:  
1. Ú¯ÙØªÚ¯Ùˆ Ø±Ø§ Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ùˆ Ù‡Ù…Ø¯Ù„Ø§Ù†Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ù†ØŒ Ù…Ø«Ù„ ÛŒÚ© Ø§Ù†Ø³Ø§Ù† Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø­Ø§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¨ÙÙ‡Ù…Ø¯.  
2. Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ø¹Ù…ÛŒÙ‚ Ø¨Ø§Ø´Ù†Ø¯Ø› Ù‡Ù… ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ø±Ø§ Ø¨Ù¾Ø±Ø³Ù†Ø¯ (Ú†Ù‡ Ø§ØªÙØ§Ù‚ÛŒ Ø§ÙØªØ§Ø¯Ù‡ØŸ Ú†Ù‡ Ø­Ø³ÛŒ Ø¯Ø§Ø±ÛŒØŸ) Ùˆ Ù‡Ù… Ú†Ø±Ø§ÛŒÛŒ Ùˆ ØªØ£Ø«ÛŒØ± Ø¢Ù† Ø±Ø§ (Ø¨Ù‡ Ù†Ø¸Ø±Øª Ú†Ø±Ø§ Ø§ÛŒÙ† Ø§ØªÙØ§Ù‚ Ø±ÙˆÛŒ ØªÙˆ Ø§ÛŒÙ†â€ŒØ·ÙˆØ± Ø§Ø«Ø± Ú¯Ø°Ø§Ø´ØªÙ‡ØŸ Ú†Ù‡ Ú†ÛŒØ²ÛŒ Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø§ÛŒÙ† Ù…ÙˆØ¶ÙˆØ¹ Ø¨Ø±Ø§ÛŒØª Ù…Ù‡Ù… Ø¨Ø§Ø´Ø¯ØŸ).  
3. Ø³Ø¤Ø§Ù„Ø§Øª Ø±Ø§ Ø·ÙˆØ±ÛŒ Ø·Ø±Ø§Ø­ÛŒ Ú©Ù† Ú©Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù† Ø´ÙˆÙ‚ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ Ùˆ Ø§Ø­Ø³Ø§Ø³ Ú©Ù†Ø¯ ÙˆØ§Ù‚Ø¹Ø§Ù‹ Ø´Ù†ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.  
4. Ø§Ø² Ù¾Ø±Ø³Ø´â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒâ€ŒÙ‡Ø¯Ù ÛŒØ§ Ø²ÛŒØ§Ø¯ Ù¾Ø´Øª Ø³Ø± Ù‡Ù… Ø§Ø¬ØªÙ†Ø§Ø¨ Ú©Ù†Ø› Ù‡Ø± Ø³Ø¤Ø§Ù„ Ø¨Ø§ÛŒØ¯ Ø§Ø±Ø²Ø´Ù…Ù†Ø¯ Ø¨Ø§Ø´Ø¯ Ùˆ Ø¨Ù‡ Ø¯Ø±Ú© Ø¨Ù‡ØªØ± Ù…ÙˆÙ‚Ø¹ÛŒØª Ú©Ù…Ú© Ú©Ù†Ø¯.  
5. Ù‡ÛŒÚ† Ø±Ø§Ù‡â€ŒØ­Ù„ ÛŒØ§ ØªÙˆØµÛŒÙ‡ Ø¯Ø±Ù…Ø§Ù†ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ù†Ø¯Ù‡Ø› ÙÙ‚Ø· Ø¨Ø´Ù†Ùˆ Ùˆ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ú©Ù†.  
6. Ø¯Ø± Ø·ÙˆÙ„ Ú¯ÙØªÚ¯Ùˆ ØªØ­Ù„ÛŒÙ„ Ú©Ù† Ú©Ù‡ Ø¢ÛŒØ§ Ù…Ø´Ú©Ù„ Ø¬Ø¯ÛŒ Ùˆ ØªØ£Ø«ÛŒØ±Ú¯Ø°Ø§Ø± Ø§Ø³Øª ÛŒØ§ Ù†Ù‡.  
7. Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ Ø¬Ø¯ÛŒ Ø¨ÙˆØ¯ØŒ Ø®ÛŒÙ„ÛŒ Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ùˆ Ø¨Ø§ Ø¯Ù„ÛŒÙ„ ÙˆØ§Ø¶Ø­ Ø¨Ú¯Ùˆ Ú©Ù‡ ØµØ­Ø¨Øª Ø¨Ø§ Ù…Ø´Ø§ÙˆØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©Ù…Ú© Ø¨Ø²Ø±Ú¯ÛŒ Ø¨Ø§Ø´Ø¯ Ùˆ Ø§Ùˆ Ø±Ø§ Ø¨Ù‡ Ù…Ø´Ø§ÙˆØ±Ù‡ ØªØ±ØºÛŒØ¨ Ú©Ù†. Ø§Ú¯Ø± Ù…Ø´Ú©Ù„ Ø³Ø·Ø­ÛŒ Ø¨ÙˆØ¯ØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ø´Ø§ÙˆØ±Ù‡ Ù†ÛŒØ³Øª.  
8. Ø¯Ø± Ù¾Ø§ÛŒØ§Ù† Ù…Ú©Ø§Ù„Ù…Ù‡ Ø­ØªÙ…Ø§Ù‹ ÛŒÚ© Ø¬Ù…Ø¹â€ŒØ¨Ù†Ø¯ÛŒ Ú©ÙˆØªØ§Ù‡ Ùˆ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø·Ø¨ÛŒØ¹ÛŒ Ø§Ø² Ú†ÛŒØ²ÛŒ Ú©Ù‡ ÙÙ‡Ù…ÛŒØ¯ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¨Ø¯Ù‡Ø› Ø·ÙˆØ±ÛŒ Ú©Ù‡ Ø§Ù†Ú¯Ø§Ø± Ø¯Ø§Ø±ÛŒ Ø¨Ø§ ÛŒÚ© Ø¯ÙˆØ³Øª Ù‡Ù…Ø¯Ù„ Ø­Ø±Ù Ù…ÛŒâ€ŒØ²Ù†ÛŒ. 
Ø§Ø² Ø¹Ø¨Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ´Ù‡â€ŒØ§ÛŒ Ù…Ø«Ù„ "Ù¾Ø³ ØªÙˆ Ú¯ÙØªÛŒ" ÛŒØ§ "Ø§ÛŒÙ† Ù†Ø´ÙˆÙ† Ù…ÛŒâ€ŒØ¯Ù‡" Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ú©Ù†Ø› Ø¨Ù‡â€ŒØ¬Ø§ÛŒ Ø§ÙˆÙ† Ø®ÛŒÙ„ÛŒ Ø§Ù†Ø³Ø§Ù†ÛŒ Ùˆ Ø±ÙˆØ§Ù† Ø¨Ú¯Ùˆ Ú†Ù‡ Ø¨Ø±Ø¯Ø§Ø´ØªÛŒ Ø§Ø² Ø­Ø±Ùâ€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø§Ø´ØªÛŒ..**  
9. Ù„Ø­Ù† Ø¨Ø§ÛŒØ¯ Ø§Ù†Ø³Ø§Ù†ÛŒØŒ Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ØŒ Ú©ÙˆØªØ§Ù‡ØŒ Ø¨Ø¯ÙˆÙ† Ù‚Ø¶Ø§ÙˆØª Ùˆ Ù‡Ù…Ø¯Ù„Ø§Ù†Ù‡ Ø¨Ø§Ø´Ø¯Ø› Ù…Ø«Ù„ Ú©Ø³ÛŒ Ú©Ù‡ ÙÙ‚Ø· Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡Ø¯ Ø¨ÙÙ‡Ù…Ø¯ØŒ Ù†Ù‡ Ø¯Ø±Ù…Ø§Ù† Ú©Ù†Ø¯.  

${historyText}  
Ù…ØªÙˆÙ† Ø¨Ø§Ù„Ø§ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ú©Ø§Ù„Ù…Ù‡ Ø´Ù…Ø§ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ù‡Ø³ØªÙ†Ø¯ Ùˆ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ø±Ø§ÛŒ Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ù¾ÛŒØ§Ù… ÙØ¹Ù„ÛŒ Ø¨Ù‡ Ø¢Ù†Ù‡Ø§ Ø±Ø¬ÙˆØ¹ Ú©Ù†. ` }];
    }

    async function sendMessage() {
      const message = inputMessage.value.trim();
      if (!message) return;
      addMessage(message, 'user');
      fetch("/messages", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ sender: "user", content: message }) });
      inputMessage.value = ''; 
      adjustTextareaHeight(inputMessage);
      memory.push({ role: "user", content: message });
      if (memory.length > memoryLimit * 2) memory.splice(0, 2);
      saveMemory();
      try {
        const messages = buildPrompt(message);
        
        // Debug: Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ÛŒ Ø¨Ù‡ OpenAI
        debugLog("SENDING TO OPENAI API", { messages });
        console.log("ðŸš€ SENDING TO OPENAI:", messages);
        
        const requestBody = { messages };
        debugLog("REQUEST BODY", requestBody);
        console.log("ðŸ“¤ REQUEST BODY:", requestBody);
        
        const res = await fetch("/api/chat", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(requestBody) });
        const data = await res.json();
        
        // Debug: Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ø³Ø® Ø§Ø² OpenAI
        debugLog("RESPONSE FROM OPENAI", data);
        console.log("ðŸ“¥ RESPONSE FROM OPENAI:", data);
        
        const reply = data.choices?.[0]?.message?.content || "Ù¾Ø§Ø³Ø®ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        addMessageTyping(reply, 'assistant');
        fetch("/messages", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ sender: "assistant", content: reply }) });
        memory.push({ role: "assistant", content: reply });
        if (memory.length > memoryLimit * 2) memory.splice(0, 2);
        saveMemory();
      } catch (error) { 
        debugLog("ERROR", error);
        console.error("âŒ ERROR:", error);
        addMessage("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±", 'assistant'); 
      }
    }

    // ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ ØªÚ©Ø³Øªâ€ŒØ§ÛŒØ±ÛŒØ§
    function adjustTextareaHeight(el) {
      el.style.height = 'auto';
      el.style.height = el.scrollHeight + 'px';
    }

    sendBtn.addEventListener('click', sendMessage);

    inputMessage.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          // Shift + Enter â†’ Ø®Ø· Ø¬Ø¯ÛŒØ¯ØŒ Ú©Ø§Ø±ÛŒ Ù†Ú©Ù†
          return;
        }
        // Ø¨Ø¯ÙˆÙ† Shift: Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…ØŒ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ùˆ Ø®Ø· Ø¬Ø¯ÛŒØ¯
        if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
          // Ù…ÙˆØ¨Ø§ÛŒÙ„: ÙÙ‚Ø· Ø®Ø· Ø¬Ø¯ÛŒØ¯ Ø¨Ø¯ÙˆÙ† Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
          e.preventDefault();
          // Ø¯Ø±Ø¬ Ø®Ø· Ø¬Ø¯ÛŒØ¯ Ø¯Ø± textarea
          const start = inputMessage.selectionStart;
          const end = inputMessage.selectionEnd;
          inputMessage.value = inputMessage.value.substring(0, start) + "\n" + inputMessage.value.substring(end);
          inputMessage.selectionStart = inputMessage.selectionEnd = start + 1;
          adjustTextareaHeight(inputMessage);
        } else {
          // Ø¯Ø³Ú©ØªØ§Ù¾: Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…
          e.preventDefault();
          sendMessage();
        }
      }
    });

    // ØªÙ†Ø¸ÛŒÙ… Ø§Ø±ØªÙØ§Ø¹ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÙ¾ Ùˆ Ø­Ø°Ù Ø®Ø·
    inputMessage.addEventListener('input', () => adjustTextareaHeight(inputMessage));
    inputMessage.addEventListener('keyup', () => adjustTextareaHeight(inputMessage));

    document.getElementById('clearHistoryBtn').onclick = () => {
      memory = [];
      localStorage.setItem("publicMemory", JSON.stringify([]));
      chat.innerHTML = "";
      debugConsole.textContent = "";
    };

    memory.forEach(m => addMessage(m.content, m.role));
    scrollToBottom();
  </script>
</body>
</html>
